@model List<ProductViewModel>


@section topCss{
        <link href="~/Asset/Css/Product/ProductCategory.css" rel="stylesheet" />
        <link href="~/Asset/Css/PartialView/category-sidenav.css" rel="stylesheet" />
        <link href="~/Asset/Css/Product/ShopCartIconPartial.css" rel="stylesheet" />
}




    <div class="container-fluid col-12" style="padding-top: 80px;">
        <section class="product-index">
            <div class="main ">
                <div class="container-fluid">
                    <div class="product-breadcrumb">
                        <a href="/Product/Index">首頁</a>
                        <i class="fas fa-chevron-right"></i>
                        <a href="#">商品分類</a>
                    </div>
                    <div class="row">

                        <div class="main-result col-lg-12 flex-wrap">


                            <div class="render-section">

                                <div id="cbp-vm" class="cbp-vm-switcher cbp-vm-view-grid">
                                    <div class="cbp-vm-options d-flex">
                                        <div class="search-result-status ">
                                            <div class="search-result-num d-flex">

                                                <div>共有<span class="search-result-total"></span>筆商品</div>
                                            </div>
                                        </div>
                                        <a href="#" class="cbp-vm-icon cbp-vm-grid cbp-vm-selected"
                                           data-view="cbp-vm-view-grid"><i class="fas fa-th"></i></a>
                                        <a href="#" class="cbp-vm-icon cbp-vm-list" data-view="cbp-vm-view-list">
                                            <i class="fas fa-list"></i>
                                        </a>

                                    </div>
                                    <div class="sort-box">
                                        <span col-lg-1>排序</span>
                                        <button class="col-lg-2 sort-btn-price sort-btn" data-type="price">
                                            @Html.ActionLink("價格排序", "ProductCategory", new { CategoryId = ViewBag.CategoryId, Order = 1 })
                                        </button>
                                        <button class="col-lg-2 sort-btn">@Html.ActionLink("上市日期排序", "ProductCategory", new { CategoryId = ViewBag.CategoryId, Order = 2 })</button>
                                    </div>
                                    <ul>
                                        @*@Html.Action("ProductPartial")*@

                                        @foreach (var item in Model)
                                        {

                                            <li class="book-list">
                                                <a class="cbp-vm-image" href="@Url.Action("ProductDetail", "Product", new { id = item.Id }, null)"><img src="@item.MainUrl"></a>
                                                <h3 class="cbp-vm-title">  @Html.ActionLink(@item.Name, "ProductDetail", "Product", new { id = item.Id }, null)</h3>
                                                <div class="cbp-vm-price">NT$ <span>@(String.Format("{0:N0}",item.UnitPrice))</span></div>
                                                <div class="cbp-vm-details">
                                                    @item.Author
                                                </div>
                                                <button class="cbp-vm-icon cbp-vm-add js-add-product" onclick="AddCart(@item.Id)">
                                                    加入購物車
                                                </button>

                                                <a class="wish-list " onclick="AddFavorite(@item.Id)"><i class="fas fa-heart"></i></a>
                                            </li>

                                        }


                                    </ul>
                                </div>

                            </div>
                        </div>


                    </div>


                </div>
            </div>
        </section>
    </div>
    <div class="shop-icon">
        <a class=" js-toggle-cart" href="#" title="View cart">

            <i class="fas fa-shopping-cart shop-cartid-icon"></i>
        </a>
    </div>

    <aside class="cart js-cart">
        <div class="cart__header">
            <h1 class="cart__title">購物車</h1>
            <p class="cart__text">
                <a class="cart-button button--light js-toggle-cart" href="#" title="Close cart">
                    關閉購物車
                </a>
            </p>
        </div>
        <div class="cart__products js-cart-products">

            @foreach (var item in ViewBag.shoppincart)
            {
                <div class="cart__product js-cart-product-template ">
                    <article class="js-cart-product row">
                        <h4 class="col-12" style="font-size:20px;">@item.ProductName</h4>
                        <img src="@item.PicUrl" alt="書圖" class="col-9" />
                        <div class="col-3" style="align-self:flex-end;text-align:end;">
                            <p class="price">@item.Price</p>
                            <p>
                                @*<button onclick="DeleteCart(@item.ProductId)"class="js-remove-product" title="Delete product">删除商品</button>*@
                                <a class="js-remove-product" href="#" title="Delete product" onclick="DeleteCart(@item.ProductId)">
                                    刪除商品
                                </a>
                            </p>
                        </div>
                    </article>
                </div>
            }

        </div>
        <div class="cart__footer">
            <p class="cart__text">
                <a class="cart-button" href="/Order/Index" title="Buy products" >
                    購買
                </a>
            </p>
        </div>
    </aside>

    <div class="lightbox js-lightbox js-toggle-cart"></div>


    @section EndJs{
        <script src="~/Asset/Js/Product/ProductCategory.js"></script>

        <script>
            function AddCart(id) {
                let productId = id;
                $.ajax({
                    type: "POST",
                    url: "/Order/AddToCart",
                    data: { Id: productId },
                    dataType: "text",
                    success: function (response) {
                        $("#MyCart").text("購物車(" + response + ")");
                    }
                });
                $.ajax({
                    type: "POST",
                    url: "/Product/ProductCategory",
                    data: { Id: productId },
                    dataType: "text",
                    success: function (response) {
                        $(".js-cart-product-template").text("購物車(" + response + ")");
                        
                    }
                });
            }


            function AddFavorite(id) {
                let favId = id

                $.ajax({
                    type: "POST",
                    url: "/MemberCenter/AddToFavorite",
                    data: { Id: favId },
                    dataType: html,
                    success: function (response) {
                        $("#MyCart").text("購物車(" + response + ")");
                    }
                });
            }
            function DeleteCart(id) {
                let productId = id;

                $.ajax({
                    type: "POST",
                    url: "/Order/DeleteFromCart",
                    data: { ProductId: productId },
                    dataType: "text",
                    success: function () {
                    }
                });
            }
        </script>
        <script>
            var cartOpen = false;
            var numberOfProducts = 0;

            $('body').on('click', '.js-toggle-cart', toggleCart);
            $('body').on('click', '.js-add-product', addProduct);
            $('body').on('click', '.js-remove-product', removeProduct);
            $('body').on('click', '.open', closeCart);

            function toggleCart(e) {
                e.preventDefault();
                if (cartOpen) {
                    closeCart();
                    return;
                }
                openCart();
            }

            function openCart() {
                cartOpen = true;
                $('body').addClass('open');
            }

            function closeCart() {
                cartOpen = false;
                $('body').removeClass('open');
            }

            function addProduct(e) {
                e.preventDefault();
                //openCart();
                numberOfProducts++;
            }

            function removeProduct(e) {
                e.preventDefault();
                numberOfProducts--;
                $(this).closest('.js-cart-product').hide(250);
                if (numberOfProducts == 0) {
                    $('.js-cart-empty').removeClass('hide');
                }
            }
        </script>

        

    }
